<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>제조 AI/DX 용어집</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <img class="brandLogo" src="/static/hyundai-wia-logo.jpg" alt="HYUNDAI WIA" />
        <div class="brandText">
          <h1>제조 AI/DX 용어집</h1>
          <p class="sub"></p>
        </div>
      </div>
    </header>

    <section class="search">
      <input id="q" placeholder="예: RAG, OEE, MES, 예지보전" autocomplete="off" />

      <select id="category">
        <option value="">전체 카테고리</option>
      </select>

      <button id="btnSearch">검색</button>
      <button id="btnExport" class="secondary">엑셀 다운로드</button>
      <button id="btnDraft" class="secondary" {{ 'disabled' if not llm_enabled else '' }}>
        없음 → 초안 생성
      </button>

      {% if llm_enabled %}
      <label class="toggle">
        <input type="checkbox" id="autoDraft" />
        검색 결과 없으면 자동으로 초안 생성
      </label>
      {% else %}
      <div class="hint">LLM 초안 생성은 현재 비활성화(LLM_MODE=off) 상태입니다.</div>
      {% endif %}
    </section>

    <section class="upload">
      <div class="uploadRow">
        <input id="uploadFile" type="file" accept=".xlsx" />
        <button id="btnPreview" class="secondary accentOutline">업로드 비교</button>
        <button id="btnApply" class="secondary" style="display:none">업로드 적용</button>
        {% if llm_enabled %}
        <label class="toggle">
          <input type="checkbox" id="fillMissing" checked />
          빈 칸은 LLM이 채우기
        </label>
        {% else %}
        <label class="toggle">
          <input type="checkbox" id="fillMissing" disabled />
          빈 칸 자동 채우기(LLM 비활성)
        </label>
        {% endif %}
      </div>
      <div class="hint">엑셀 1행은 헤더. 최소 "용어(KR)" 컬럼이 필요해.</div>
    </section>

    <main class="grid">
      <section class="results">
        <div id="results"></div>
      </section>

      <section class="detail">
        <div id="detail"></div>
      </section>
    </main>
  </div>

<script>
const $ = (id) => document.getElementById(id);

function escapeHtml(s){
  return (s||'').replace(/[&<>"']/g, (c)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

async function loadCategories(){
  const res = await fetch('/api/categories');
  const data = await res.json();
  const sel = $('category');
  (data.categories||[]).forEach(c=>{
    const opt = document.createElement('option');
    opt.value = c;
    opt.textContent = c;
    sel.appendChild(opt);
  });
}

async function search(){
  const q = $('q').value.trim();
  const category = $('category').value;
  // allow empty search to show default 100 entries
  $('detail').innerHTML = '';
  const res = await fetch('/api/search?q='+encodeURIComponent(q)+'&category='+encodeURIComponent(category));
  const data = await res.json();
  if(!data.results || data.results.length===0){
    $('results').innerHTML = '<div class="muted">일치 항목 없음.</div>';
    // optional auto-draft when enabled
    const auto = $('autoDraft');
    if(auto && auto.checked){
      await draft();
      return;
    }
    $('results').innerHTML += '<div class="muted">("없음 → 초안 생성" 가능)</div>';
    return;
  }
  $('results').innerHTML = data.results.map(r=>
    `<div class="card" onclick="loadTerm('${escapeHtml(r.kr)}')">
      <div class="title">${escapeHtml(r.kr)} <span class="tag">${escapeHtml(r.en||'')}</span></div>
      <div class="meta">${escapeHtml(r.category||'')}</div>
      <div class="desc">${escapeHtml(r.oneLine||'')}</div>
    </div>`
  ).join('');
}

async function loadTerm(term){
  const res = await fetch('/api/term?term='+encodeURIComponent(term));
  if(!res.ok){ $('detail').innerHTML = '<div class="muted">상세를 불러오지 못했어.</div>'; return; }
  const t = await res.json();
  renderDetail(t);
}

function renderDetail(t){
  const kpi = (t.kpi||[]).map(x=>`<span class="pill">${escapeHtml(x)}</span>`).join(' ');
  const conf = (t.confusions||[]).map(x=>`<span class="pill">${escapeHtml(x)}</span>`).join(' ');
  const sourceTag = t.createdBy || t.source || 'USER';

  $('detail').innerHTML = `
    <div class="panel">
      <div class="panelTitle">${escapeHtml(t.kr)} <span class="tag">${escapeHtml(t.en||'')}</span> <span class="tag">${escapeHtml(sourceTag)}</span></div>

      <div class="row"><b>분류</b> ${escapeHtml(t.category||'')}</div>
      <div class="row"><b>한줄 정의</b><div>${escapeHtml(t.oneLine||'')}</div></div>
      <div class="row"><b>예시</b><div>${escapeHtml(t.example||'')}</div></div>
      <div class="row"><b>KPI</b><div>${kpi || '<span class="muted">-</span>'}</div></div>
      <div class="row"><b>혼동 용어</b><div>${conf || '<span class="muted">-</span>'}</div></div>
      <div class="actions">
        <button class="secondary" onclick="toggleEdit(true)">수정</button>
      </div>

      <div id="editBox" class="edit" style="display:none">
        <div class="editGrid">
          <label>용어(KR) <input id="e_kr" /></label>
          <label>약어/EN <input id="e_en" /></label>
          <label>분류 <input id="e_category" placeholder="전략/데이터/AI/자동화/운영/보안/성과" /></label>
          <label>한줄 정의 <textarea id="e_oneLine" rows="2"></textarea></label>
          <label>예시 <textarea id="e_example" rows="2"></textarea></label>
          <label>KPI (쉼표/줄바꿈) <textarea id="e_kpi" rows="2"></textarea></label>
          <label>혼동 용어 (쉼표/줄바꿈) <textarea id="e_confusions" rows="2"></textarea></label>
        </div>
        <div class="actions">
          <button onclick="saveEdit()">저장</button>
          <button class="secondary" onclick="toggleEdit(false)">취소</button>
        </div>
      </div>
    </div>
  `;

  // fill form
  $('e_kr').value = t.kr || '';
  $('e_en').value = t.en || '';
  $('e_category').value = t.category || '';
  $('e_oneLine').value = t.oneLine || '';
  $('e_example').value = t.example || '';
  $('e_kpi').value = (t.kpi||[]).join(', ');
  $('e_confusions').value = (t.confusions||[]).join(', ');
}

function toggleEdit(on){
  const box = $('editBox');
  if(!box) return;
  box.style.display = on ? 'block' : 'none';
}

function splitList(s){
  if(!s) return [];
  return s.split(/\n|,/).map(x=>x.trim()).filter(Boolean);
}

async function saveEdit(){
  const payload = {
    kr: $('e_kr').value.trim(),
    en: $('e_en').value.trim(),
    category: $('e_category').value.trim(),
    oneLine: $('e_oneLine').value.trim(),
    example: $('e_example').value.trim(),
    kpi: splitList($('e_kpi').value),
    confusions: splitList($('e_confusions').value),
    createdBy: 'USER',
  };

  $('detail').insertAdjacentHTML('beforeend', '<div class="muted" id="saveMsg">저장 중…</div>');
  const res = await fetch('/api/save', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
  const data = await res.json();
  const msg = $('saveMsg');
  if(msg) msg.remove();

  if(!res.ok){
    $('results').innerHTML = '<div class="muted">저장 실패: '+escapeHtml(data.error||'')+'</div>';
    return;
  }
  toggleEdit(false);
  renderDetail(data.item);
}

async function draft(){
  const term = $('q').value.trim();
  if(!term){ return; }
  $('detail').innerHTML = '<div class="muted">초안 생성 중…</div>';
  const form = new FormData();
  form.append('term', term);
  const res = await fetch('/api/draft', { method:'POST', body: form });
  const data = await res.json();
  if(!res.ok){ $('detail').innerHTML = '<div class="muted">초안 생성 실패: '+escapeHtml(data.error||'')+'</div>'; return; }
  renderDetail(data.item);
}

let uploadPreview = null;
let uploadDecisions = {};
let uploadDefaultDecision = 'merge';

function renderUploadPreview(p){
  uploadPreview = p;
  uploadDecisions = {};
  uploadDefaultDecision = 'merge';

  const s = p.summary || {};
  const conflicts = p.conflicts || [];

  // show apply button
  $('btnApply').style.display = 'inline-block';

  const rows = conflicts.map((c, idx)=>{
    const diff = (c.diffKeys||[]).join(', ') || '-';
    const kr = c.kr || (c.existing && c.existing.kr) || (c.incoming && c.incoming.kr) || '';
    return `
      <tr>
        <td><input type="checkbox" class="csel" data-kr="${escapeHtml(kr)}" checked /></td>
        <td>${escapeHtml(kr)}</td>
        <td class="muted">${escapeHtml(diff)}</td>
        <td>
          <select class="cdec" data-kr="${escapeHtml(kr)}">
            <option value="existing">기존 우선</option>
            <option value="incoming">신규 우선</option>
            <option value="merge" selected>중복 합치기</option>
          </select>
        </td>
        <td><div class="small"><b>기존</b>: ${escapeHtml((c.existing&&c.existing.oneLine)||'') }</div></td>
        <td><div class="small"><b>신규</b>: ${escapeHtml((c.incoming&&c.incoming.oneLine)||'') }</div></td>
      </tr>
    `;
  }).join('');

  $('results').innerHTML = `
    <div class="panel">
      <div class="panelTitle">업로드 비교</div>
      <div class="row"><b>총 행</b> ${s.total||0}</div>
      <div class="row"><b>신규 추가</b> ${s.adds||0}</div>
      <div class="row"><b>중복(비교 필요)</b> ${s.conflicts||0}</div>
      <div class="row"><b>LLM 채움</b> ${s.filledByLLM||0}</div>

      <div class="actions" style="justify-content:space-between">
        <div style="display:flex;gap:8px;align-items:center">
          <label class="toggle" style="margin-left:0">
            <input type="checkbox" id="selectAll" checked />
            전체 선택
          </label>
          <select id="bulkDecision">
            <option value="existing">선택 항목: 기존 우선</option>
            <option value="incoming">선택 항목: 신규 우선</option>
            <option value="merge" selected>선택 항목: 중복 합치기</option>
          </select>
          <button class="secondary" id="btnBulkApply">선택에 적용</button>
        </div>
        <div class="muted">※ 실제 반영은 "업로드 적용" 버튼을 눌러야 함</div>
      </div>

      <div style="overflow:auto">
        <table class="table">
          <thead>
            <tr>
              <th></th>
              <th>용어(KR)</th>
              <th>차이</th>
              <th>처리</th>
              <th>기존 한줄</th>
              <th>신규 한줄</th>
            </tr>
          </thead>
          <tbody>
            ${rows || '<tr><td colspan="6" class="muted">중복 항목 없음(바로 적용 가능)</td></tr>'}
          </tbody>
        </table>
      </div>
    </div>
  `;

  // bind bulk controls
  const selAll = $('selectAll');
  selAll.addEventListener('change', ()=>{
    document.querySelectorAll('.csel').forEach(x=>{ x.checked = selAll.checked; });
  });

  $('btnBulkApply').addEventListener('click', ()=>{
    const v = $('bulkDecision').value;
    document.querySelectorAll('.csel').forEach(chk=>{
      if(!chk.checked) return;
      const kr2 = chk.getAttribute('data-kr');
      const dec = document.querySelector(`.cdec[data-kr="${CSS.escape(kr2)}"]`);
      if(dec) dec.value = v;
    });
  });
}

async function uploadPreviewXlsx(){
  const f = $('uploadFile').files && $('uploadFile').files[0];
  if(!f){ $('results').innerHTML = '<div class="muted">업로드할 .xlsx 파일을 선택해줘.</div>'; return; }

  $('btnApply').style.display = 'none';
  $('results').innerHTML = '<div class="muted">업로드 비교 중…</div>';
  const form = new FormData();
  form.append('file', f);
  const fill = $('fillMissing');
  form.append('fillMissing', (fill && fill.checked) ? 'on' : 'off');

  const res = await fetch('/api/upload.preview', { method:'POST', body: form });
  const data = await res.json();
  if(!res.ok){
    $('results').innerHTML = '<div class="muted">비교 실패: '+escapeHtml(data.detail||data.error||'')+'</div>';
    return;
  }
  renderUploadPreview(data);
}

async function uploadApplyXlsx(){
  if(!uploadPreview){ $('results').innerHTML = '<div class="muted">먼저 업로드 비교를 실행해줘.</div>'; return; }

  // collect decisions from UI
  const decisions = {};
  document.querySelectorAll('.cdec').forEach(sel=>{
    const kr = sel.getAttribute('data-kr');
    decisions[kr] = sel.value;
  });

  $('results').insertAdjacentHTML('afterbegin','<div class="muted" id="applyMsg">적용 중…</div>');
  const res = await fetch('/api/upload.apply', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({
      entries: uploadPreview.entries || [],
      decisions,
      defaultDecision: 'merge'
    })
  });
  const data = await res.json();
  const m = document.getElementById('applyMsg');
  if(m) m.remove();

  if(!res.ok){
    $('results').innerHTML = '<div class="muted">적용 실패: '+escapeHtml(data.error||'')+'</div>';
    return;
  }

  const r = data.report || {};
  $('results').innerHTML = `
    <div class="panel">
      <div class="panelTitle">업로드 적용 완료</div>
      <div class="row"><b>추가</b> ${r.added||0}</div>
      <div class="row"><b>업데이트(신규우선)</b> ${r.updated||0}</div>
      <div class="row"><b>중복합치기</b> ${r.merged||0}</div>
      <div class="row"><b>스킵(기존우선)</b> ${r.skipped||0}</div>
      <div class="row"><b>총 용어수</b> ${data.count||0}</div>
    </div>
  `;

  // refresh browse list
  await search();
}

$('btnSearch').addEventListener('click', search);
$('btnExport').addEventListener('click', ()=>{ window.location.href = '/api/export.xlsx'; });
$('btnPreview').addEventListener('click', uploadPreviewXlsx);
$('btnApply').addEventListener('click', uploadApplyXlsx);
$('q').addEventListener('keydown', (e)=>{ if(e.key==='Enter') search(); });
$('btnDraft').addEventListener('click', draft);

loadCategories().then(()=>search());
window.loadTerm = loadTerm;
</script>
</body>
</html>
